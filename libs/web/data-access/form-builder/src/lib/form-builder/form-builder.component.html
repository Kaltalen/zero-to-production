<!-- TODO -> Section / Field preview and icons -->

<aside class="toolbox">
  <div cdkDropList [cdkDropListConnectedTo]="[formSections]">
    <div cdkDrag class="toolbox-element">Form Group</div>
  </div>
  <div cdkDropList [cdkDropListConnectedTo]="['groupFields']">
    <div cdkDrag class="toolbox-element">Form Field</div>
  </div>
</aside>

<mat-divider [vertical]="true"></mat-divider>

<section class="form-builder">
  <form [formGroup]="builderForm" (ngSubmit)="onSubmit(builderForm)">
    <div>
      <uqt-form-builder-header
        [name]="builderForm.value.config.formName"
        (toggleConfig)="toggleFormConfig()"
      ></uqt-form-builder-header>

      <uqt-form-builder-config *ngIf="showFormConfig" [form]="builderForm">
      </uqt-form-builder-config>
    </div>

    <!-- 
      TODO -> Wait for Angular Material v9 
      https://github.com/angular/components/pull/17424
     -->
    <div
      class="form-sections"
      formArrayName="formGroups"
      cdkDropList
      #formSections="cdkDropList"
      (cdkDropListDropped)="formGroupDropped($event)"
    >
      <mat-card
        cdkDrag
        class="group-section"
        *ngFor="let group of formGroups.controls; let i = index"
      >
        <div [formGroupName]="i">
          <div class="group-settings">
            <mat-form-field>
              <mat-label>Section Name</mat-label>
              <input matInput type="text" formControlName="groupName" />
            </mat-form-field>

            <button mat-icon-button type="button" (click)="deleteFormGroup(i)">
              <mat-icon>delete</mat-icon>
            </button>

            <div class="move-handle" cdkDragHandle>
              <svg width="24px" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"
                ></path>
                <path d="M0 0h24v24H0z" fill="none"></path>
              </svg>
            </div>
          </div>
          <mat-divider [inset]="true"></mat-divider>

          <div
            id="groupFields"
            class="group-fields"
            formArrayName="fields"
            cdkDropList
            #groupFields="cdkDropList"
            (cdkDropListDropped)="formFieldDropped(i, $event)"
          >
            <div
              cdkDrag
              *ngFor="let field of getGroupFields(i).controls; let idx = index"
            >
              <div>
                <button
                  mat-icon-button
                  type="button"
                  (click)="showFormField(i, idx)"
                >
                  <mat-icon>expand_more</mat-icon>
                </button>

                <button
                  mat-icon-button
                  type="button"
                  (click)="removeGroupField(i, idx)"
                >
                  <mat-icon>clear</mat-icon>
                </button>
              </div>

              <div
                *ngIf="
                  fieldVisible.groupIndex === i &&
                  fieldVisible.fieldIndex === idx
                "
                [formGroupName]="idx"
              >
                <mat-form-field appearance="outline">
                  <mat-label>Field Name</mat-label>
                  <input matInput type="text" formControlName="fieldName" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Field Label (display)</mat-label>
                  <input matInput type="text" formControlName="fieldLabel" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Field Type</mat-label>
                  <mat-select formControlName="fieldType">
                    <mat-option [value]="0">Text Field</mat-option>
                    <mat-option [value]="1">Number Field</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </mat-card>
    </div>
  </form>
</section>
